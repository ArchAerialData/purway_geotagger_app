name: macos-notarize-finalize

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "macos-build workflow run id (e.g., 21793990363)"
        required: true
        type: string
      wait_timeout:
        description: "Max time to wait for Apple notarization in this finalize run (e.g., 10m, 30m)"
        required: false
        default: "20m"
        type: string

jobs:
  finalize:
    runs-on: macos-14
    timeout-minutes: 45
    steps:
      - name: Checkout (for scripts)
        uses: actions/checkout@v4

      - name: Download macos-build artifact (DMG + submission id)
        env:
          REPO: ${{ github.repository }}
          RUN_ID: ${{ inputs.build_run_id }}
          ARTIFACT_NAME: PurwayGeotagger-macos
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts"
          echo "Listing artifacts for run ${RUN_ID}..."
          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${api}" > artifacts.json

          url="$(python3 - <<'PY'
          import json, os, sys
          data=json.load(open("artifacts.json","r",encoding="utf-8"))
          name=os.environ["ARTIFACT_NAME"]
          for a in data.get("artifacts",[]):
              if a.get("name")==name:
                  print(a.get("archive_download_url",""))
                  sys.exit(0)
          sys.exit(f"Artifact not found: {name}")
          PY
          )"
          echo "Downloading artifact..."
          curl -fsSL -L \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${url}" -o artifact.zip

          rm -rf artifact
          mkdir -p artifact
          unzip -q artifact.zip -d artifact

          dmg="$(find artifact -maxdepth 4 -name 'PurwayGeotagger.dmg' -print -quit)"
          if [[ -z "${dmg}" ]]; then
            echo "::error::PurwayGeotagger.dmg not found in artifact."
            find artifact -maxdepth 4 -type f -print
            exit 1
          fi

          id_file="$(find artifact -maxdepth 4 -name 'notarization_submission_id.txt' -print -quit || true)"
          if [[ -z "${id_file}" ]]; then
            echo "::error::notarization_submission_id.txt not found in artifact."
            find artifact -maxdepth 4 -type f -print
            exit 1
          fi

          echo "DMG: ${dmg}"
          echo "Submission id file: ${id_file}"
          cp -f "${id_file}" "$(dirname "${dmg}")/notarization_submission_id.txt"

          echo "DMG_PATH=${dmg}" >> "${GITHUB_ENV}"

      - name: Finalize notarization (wait + staple)
        env:
          APPLE_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_API_KEY_P8: ${{ secrets.APPLE_API_KEY_P8 }}
          NOTARY_WAIT_TIMEOUT: ${{ inputs.wait_timeout }}
        run: |
          set -euo pipefail
          bash scripts/ci/macos_finalize_notarization.sh "${DMG_PATH}"

      - name: Upload stapled DMG
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: PurwayGeotagger-macos-notarized
          path: ${{ env.DMG_PATH }}
          if-no-files-found: error

